---
title: "HPV18VLP Validation"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 300)
options(dplyr.summarise.inform = FALSE)

# repo root directory
root <- system('git rev-parse --show-toplevel', intern = TRUE)

library(dplyr)
library(purrr)
library(tidyr)

library(readxl)
library(writexl)

library(knitr)

library(meta)

library(ggplot2)
library(cowplot)
theme_set(theme_cowplot())

library(nlme)

source(paste0(root, '/R/helper functions.R'))

# input file
# https://abcs-amp.cancer.gov/uploads/external/316/cd64051437525a8347b21bd37af151656ace9db6
f <- paste0(root, '/data/HSL_VAL_HPV18VLP_Summary_V3.1.xlsx')

# pre-validation results to use for accuracy
# not used
f2 <- ''

# for monitoring differences in column and sheet names :P
# default sheet and column names are those provided in the spike data set
# this compensates for different names in subsequent data sets
diff <- list(lloq_acon = 'Result', #'Result (Calculated Con.)',
             lloq_assay = 'HPV_Type', #'Assay',
             uloq_acon = 'Result (EU/mL)', #'Result (Calculated Con.)',
             uloq_assay = 'HPV_Type', #'Assay',
             linearity_acon = 'Result (Calculated Con.)', #'Result (AU/mL)',
             cutpoint_sheet = 'CutPoint', #'CUTPOINT',
             cutpoint_acon = 'Calculated Titer (EU/mL)', #'Result ((AU/mL))',
             cutpoint_assay = 'HPV_Type', #'Assay',
             sens_sheet1 = 'Sensitivity LLOQ', #'LLOQ_Challenge',
             sens_sheet2 = 'Sensitivity ULOQ', #'LLOQ_Challenge',
             sens_acon = 'Result', #'Calculated Result (AU/mL)',
             sens_assay = 'HPV_Type', #'Assay',
             spec_sheet = 'Specificity',
             spec_assay = 'HPV_Type',
             spec_acon = 'Calculated Titer (EU/mL)', #'Calculated Result (EU/mL)',
             acc_sheet = 'Accuracy', #'ACCURACY',
             acc_theo = 'Theoretical Result (IU/mL)',
             acc_acon = 'Experimental Result (IU/mL)', #'Calculated Result (EU/mL)', #'Result ((AU/mL))',
             acc_assay = 'HPV_Type', #'Assay',
             prec_sheet = 'Precision', #'PRECISION',
             prec_acon = 'Calculated Result (EU/mL)', #'Result ((AU/mL))',
             prec_assay = 'HPV_Type', #'Assay',
             covr_sheet = 'Carryover', #'CARRYOVER',
             covr_acon = 'Calculated Titer (EU/mL)', #'Result ((AU/mL))',
             covr_sample_id = 'Sample_ID', #'SID',
             covr_assay = 'HPV_Type', #'CoVs', #'Assay',
             stab_sheet = c('Stability_Freeze Thaw', 'Stability__Lipemia',
                            'Stability__Bilirubin', 'Stability__Hemolysis',
                            'Stability__Heat'), #'STABILITY'
             stab_acon = 'Calculated Result (EU/mL)', #'Result ((AU/mL))',
             stab_assay = 'HPV_Type', #'Assay',
             conj_sheet = 'Stability_Conjugate Lot to Lot', #'Lot-to-Lot Conjugate',
             conj_lot = 'Conjugate Lot', #'Lot Status: Old or New',
             conj_acon = 'Calculated Result (EU/mL)', #'Result ((AU/mL))',
             conj_assay = 'HPV_Type', #'Assay',
             antigen_sheet = 'Stability_VLP Lot to Lot',
             antigen_lot = 'VLP Lot', #'Lot Status: Old or New',
             antigen_acon = 'Calculated Result (EU/mL)', #'Result ((AU/mL))',
             antigen_assay = 'HPV_Type', #'Assay',
             svm_acon = 'Result ((AU/mL))')

# this is where all tables and figures for the report will be stored
tables <- list()
figures <- list()

# summary table 1, displaying acceptance criteria and procedures
# this will be filled out as we read in data from the source Excel file
tables$table1 <- tibble(Experiment = c('LLOQ', 'ULOQ', 'Linearity', 'Cutpoint', 'Sensitivity (LLOQ Challenge)', 'Sensitivity (ULOQ Challenge)',
                                'Accuracy', 'Specificity', 'Precision', 'Carry-over', 
                                'Stability (Freeze/Thaw, Matrix Components, Sample Integrity)',
                                'Stability (Critical Reagent Lot Change)'),
                        `Samples (n)` = NA,
                        Replicates = NA,
                        `Analyst(s)` = NA,
                        `Days (Runs)` = NA,
                        Methodology = NA,
                        `Acceptance Criteria` = NA)

source(paste0(root, '/R/processData.R'))
```

```{r summary table}
tables$table1 %>%
    kable(caption = 'Table 1: Analysis summary')
```


## Lower limit of quantitation (LLOQ)

The lowest reportable concentration of each analyte in the multiplex assay that passes established criteria.

```{r lloq table}
tables$lloq %>%
    kable(digits = 3, caption = paste0('Table ', which(names(tables) == 'lloq'), ': The lowest concentration for each sample, assay and analyst, based on the Percent Error ≤ ', lloq_pct_error, '% and within Dilution CV (replicates) ≤ ', lloq_rsd_pct, '%. The concentration units are represented as Arbitrary Units (AU)/mL.'))
```

```{r lloq stats table}
tables$lloq_sum %>%
    kable(digits = 3, caption = paste0('Table ', which(names(tables) == 'lloq_sum'), ': Statistics describing LLOQ statistics for each assay. The concentration units are represented as Arbitrary Units (AU)/mL.'))
```


## ULOQ (Upper limit of quantitation)

The highest reportable concentration of each analyte in the multiplex assay that passes established criteria.

```{r uloq table}
tables$uloq %>%
    kable(digits = 3, caption = paste0('Table ', which(names(tables) == 'uloq'), ': The highest concentration for each sample, assay and analyst, based on the Percent Error ≤ ', uloq_pct_error, '% and within Dilution CV (replicates) ≤ ', uloq_rsd_pct, '%. The concentration units are represented as Arbitrary Units (AU)/mL.'))
```

```{r uloq stats table}
tables$uloq_sum %>%
    kable(digits = 3, caption = paste0('Table ', which(names(tables) == 'uloq_sum'), ': Statistics describing ULOQ statistics for each assay. The concentration units are represented as Arbitrary Units (AU)/mL.'))
```


## Linearity

Linearity demonstrates that the analyte of interest, when present in concentrations exceeding the range of quantification (above ULOQ), can be accurately measured by the assay after dilution to bring the analyte concentrations into the validated range for analysis.

```{r linearity table}
tables$lin %>%
    kable(digits = c(NA, 0, 0, 3, 3, 2), caption = paste0('Table ', which(names(tables) == 'lin'), ': Linearity statistics for each Assay, including: minimum and maximum number of replicates passing acceptance criteria (Percent Error ≤ ', lin_pct_error, '% and CV ≤ ', lin_rsd_pct, '%), and minimum and maximum correlation coefficients.'))
```


## Cutpoint

Cutpoint examines the levels of analyte in reported naïve subjects to establish a population-based lower limit of quantitation based on established criteria.

```{r cutpoint table}
tables$cutpt %>%
    kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'cutpt'), ': Upper 95% Confidence Interval for COVID naïve samples.'))
```

## Sensitivity

Sensitivity - evaluates and challenges the LLOQ and ULOQ values for each analyte.

```{r lloq sensitivity table}
tables$sens %>%
    kable(digits = c(rep(1,4), 3), caption = paste0('Table ', which(names(tables) == 'sens'), ': Sensitivity data (LLOQ). Using the criteria that the lowest concentration for each sample was based on the Percent Error ≤', sens_pct_error, '% and Within Dilution CV (replicates) ≤ ', sens_rsd_pct, '%.'))
```

```{r uloq sensitivity table}
tables$sens2 %>%
    kable(digits = c(rep(1, 4), 2), caption = paste0('Table ', which(names(tables) == 'sens2'), ': Sensitivity data (ULOQ). Using the criteria that the highest concentration for each sample was based on the Percent Error ≤ ', sens_pct_error, '% and Within Dilution CV (replicates) ≤ ', sens_rsd_pct, '%.'))
```

## Accuracy and Precision

Accuracy and Precision evaluate the closeness of agreement between the true value and experimental value of a sample (Accuracy) and the degree of variability of a series of measurements of a homogeneous sample (Precision).

```{r accuracy table}
tables$acc %>%
    kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'acc'), ': Percent Error and RSD for each sample. The sample geometric mean was used as the true value. Percent Error ≤ ', acc_pct_error, '% threshold was used to define at which concentrations the assay may be deemed accurate.'))
```

```{r precision table}
tables$prec %>%
    kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'prec'), ': Intra/Inter-Day and Inter-Analyst precision. CV ≤ ', prec_rsd_pct, '% threshold was used to define at which concentrations the assay may be deemed accurate.'))
```

## Specificity

Specificity evaluates the ability of the ligand binding assay to measure an analyte in the presence of exogenous and/or endogenous proteins.

```{r specificity table}
tables$spec %>%
    kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'spec'), ': Specificity.'))
```

## Carry-over

Carry-over evaluates the presence of an analyte in a blank sample from a previously analyzed sample with a high concentration of the analyte. This process will detect false positive responses due to errors by the analyst and/or instrument analysis.

```{r caryover table}
tables$covr %>%
    kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'covr'), ': Carry-over results for each assay. The assay Carry-over passed if CV ≤ ', covr_rsd_pct, '% (replicates) for both samples, and the negative sample is ≤ LLOQ.'))
```

## Stability

Robustness (Freeze/Thaw, Matrix Components) - evaluate the ability of the starting material (analyte) to remain intact when subjected to various storage/use conditions and presence of various matrix components.

```{r stability table}
tables$stability %>%
    kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'freez'), ': Stability results. Passed if the Percent Error ≤ ', stab_pct_error, '% (1X Freeze/thaw and Control aliquots are used as the reference).'))
```


## Lot-to-Lot Comparisons

There were `r nrow(filter(conj_sum, delta == 0))` negative samples in the conjugate lot to lot tests, and `r nrow(filter(antigen_sum, delta == 0))` negative samples in the antigen lot to lot tests. These samples are not included in the table below.

```{r Lot-to-Lot table}
tables$l2l %>%
    kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'l2l'), ': Critical Reagent Lot Change. Passed if the Percent Error ≤ ', stab_pct_error, '%. Lot A is defined as the reference. The total number of seropositive results with a Percent Error ≤', stab_pct_error, '% is shown. The Lot passes if 80% of the seropositive samples (ex., 26 of the 32) have a Percent Error ≤', stab_pct_error, '%. All samples below the LLOQ were excluded from analysis.'))
```


```{r svm table}
## Single vs Multiplex Comparisons

# tables$svm %>%
#   kable(digits = 1, caption = paste0('Table ', which(names(tables) == 'svm'), ': Comparison of singleplex with multiplex assays. Each comparison passed if the Percent Error ≤25% between the two (geometric means of replicates will be used if there are more than one replicate). The total number of samples, number of samples with percent error ≤25%, and the proportion of total samples passing this threshold are given. Additional details for individual comparisons can be found in the accompanying excel file.'))
```

## Linearity plots

```{r linearity figures}
for(i in 1:length(figures$linearity_OvE_concentration))
  suppressWarnings(print(figures$linearity_OvE_concentration[[i]]))
```

```{r export raw tables}
##########################################################
# This is where we export the raw tables we've generated #
##########################################################

write_xlsx(list(LLOQ = lloq_sum,
                ULOQ = uloq_sum,
                Cutpoint = cutpt,
                Precision_by_day = prec_by_day,
                Precision_by_analyst = prec_by_analyst,
                Accuracy_by_day = acc_by_day,
                Accuracy_by_analyst = acc_by_analyst,
                Sensitivity = sens_sum,
                Caryover = covr_sum,
                Stability = stability_sum,
                Lot_to_Lot_Antigen = antigen_sum,
                Lot_to_Lot_Conjugate = conj_sum,
                Linearity = lin_sum),
                #Single_vs_Multiplex = svm_sum),
           path = 'HPV18_Results.xlsx')

```